{% extends 'core/base.html' %}
{% load static %}

{% block title %}Store Management - Veterinary System{% endblock %}

{% block content %}
<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<!-- Custom Store CSS -->
<link rel="stylesheet" href="{% static 'core/css/store.css' %}">

<!-- Enhanced Store Header -->
<header class="store-header" role="banner" aria-label="Veterinary store overview">
    <div class="store-header-content">
        <div class="store-header-text">
            <h1 class="store-title">
                <i class="fas fa-store" aria-hidden="true"></i>
                Veterinary Store
            </h1>
            <p class="store-subtitle">Premium products for your veterinary practice</p>
        </div>
        <div class="store-header-actions">
            <div class="store-summary" role="status" aria-live="polite">
                <div class="summary-item">
                    <i class="fas fa-boxes-stacked" aria-hidden="true"></i>
                    <span class="summary-label">Total Products</span>
                </div>
                <div class="summary-item">
                    <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
                    <span class="summary-label">Low Stock</span>
                </div>
            </div>
        </div>
    </div>
</header>

<main class="store-container" role="main" aria-label="Store content">
    <!-- New Layout: Header Section with ALL Product, Search Product, Shopping Cart -->
    <section class="store-controls-header" aria-label="Store controls">
        <div class="controls-container">
            <!-- ALL Product Section -->
            <div class="control-section all-products-section">
                <h2 class="control-title">
                    <i class="fas fa-boxes-stacked" aria-hidden="true"></i>
                    ALL Product
                </h2>
                <div class="products-count">
                    <span class="count-number">{{ total_products|default:"0" }}</span>
                    <span class="count-label">Products Available</span>
                </div>
            </div>

            <!-- Search Product Section -->
            <div class="control-section search-section">
                <div class="search-container">
                    <form method="GET" action="{% url 'store' %}" class="search-form" role="search">
                        <div class="search-input-group">
                            <i class="fas fa-search search-icon" aria-hidden="true"></i>
                            <input type="text"  name="search"  class="search-input"  placeholder="Search products..."  value="{{ request.GET.search }}" aria-label="Search products">
                            <button type="submit" class="search-button" aria-label="Search">
                                <i class="fas fa-search" aria-hidden="true"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Shopping Cart Section -->
            <div class="control-section cart-section">
                <h2 class="control-title">
                    <i class="fas fa-shopping-cart" aria-hidden="true"></i>
                    Shopping Cart
                </h2>
                <div class="cart-button-container">
                    <button class="cart-button" onclick="openCartModal()" aria-label="Open shopping cart">
                        <i class="fas fa-shopping-cart" aria-hidden="true"></i>
                        <span class="cart-count" id="cart-count" aria-label="Items in cart">0</span>
                        <span class="cart-total" id="cart-total" aria-label="Cart total">$0.00</span>
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Products Grid Section -->
    <section class="store-grid" aria-label="Products grid">
        {% for produit in produits %}
        <article class="product-card {% if produit.quantite == 0 %}product-out-of-stock{% endif %}" data-product-id="{{ produit.id }}" role="article" aria-labelledby="product-{{ produit.id }}-title">
            <div class="product-image-container">
                {% if produit.quantite == 0 %}
                    <div class="product-badge out-of-stock-badge">
                        <i class="fas fa-times-circle" aria-hidden="true"></i> Out of Stock
                    </div>
                {% endif %}
                {% if produit.image %}
                    <img src="{{ produit.image.url }}"  alt="{{ produit.nom }}"  class="product-image" loading="lazy">
                {% else %}
                    <div class="product-image-placeholder" aria-label="No image available">
                        <i class="fas fa-box" aria-hidden="true"></i>
                    </div>
                {% endif %}
            </div>
            
            <div class="product-content">
                <div class="product-header">
                    <h3 id="product-{{ produit.id }}-title" class="product-title">{{ produit.nom }}</h3>
                    <div class="product-category">{{ produit.categorie.nom }}</div>
                </div>
                
                <p class="product-description">{{ produit.description|default:"No description available" }}</p>
                
                <div class="product-details">
                    <div class="product-price">${{ produit.prix }}</div>
                    <div class="product-stock">
                        <span class="stock-label">Stock:</span>
                        {% if produit.quantite > 0 %}
                            <span class="stock-amount {% if produit.quantite <= 10 %}low-stock{% elif produit.quantite <= 30 %}medium-stock{% else %}high-stock{% endif %}"
                                  aria-label="Stock level: {{ produit.quantite }} units">
                                {{ produit.quantite }} units
                            </span>
                        {% else %}
                            <span class="stock-amount out-of-stock" aria-label="Product is out of stock">
                                <i class="fas fa-times-circle" aria-hidden="true"></i> Out of Stock
                            </span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="product-actions">
                    {% if produit.quantite > 0 %}
                        <button class="btn-add-to-cart" 
                                onclick="try { console.log('Button clicked for product:', '{{ produit.nom }}'); addToCart('{{ produit.id }}', '{{ produit.nom }}', '{{ produit.prix }}'); } catch(e) { console.error('Error in onclick:', e); alert('Error: ' + e.message); }"
                                aria-label="Add {{ produit.nom }} to cart"
                                data-product-id="{{ produit.id }}"
                                data-product-name="{{ produit.nom }}"
                                data-product-price="{{ produit.prix }}">
                            <i class="fas fa-shopping-cart" aria-hidden="true"></i> Add to Cart
                        </button>
                    {% else %}
                        <button class="btn-add-to-cart btn-out-of-stock" 
                                disabled
                                aria-label="{{ produit.nom }} is out of stock"
                                title="This product is currently out of stock">
                            <i class="fas fa-times-circle" aria-hidden="true"></i> Out of Stock
                        </button>
                    {% endif %}
                </div>
            </div>
        </article>
        {% empty %}
        <div class="empty-state" role="status" aria-live="polite">
            <div class="empty-state-icon">
                <i class="fas fa-box-open" aria-hidden="true"></i>
            </div>
            <h3>No Products Found</h3>
            <p>{% if request.GET.search %}No products match your search criteria.{% else %}No products are currently available in your inventory.{% endif %}</p>
            {% if request.GET.search %}
                <a href="{% url 'store' %}" class="btn-clear-search" aria-label="Clear search and show all products">
                    <i class="fas fa-times" aria-hidden="true"></i> Clear Search
                </a>
            {% endif %}
        </div>
        {% endfor %}
    </section>
</main>

<!-- Enhanced Shopping Cart Modal -->
<div class="cart-modal" id="cart-modal" role="dialog" aria-labelledby="cart-modal-title" aria-hidden="true">
    <div class="cart-modal-overlay" onclick="closeCartModal()"></div>
    <div class="cart-modal-content">
        <!-- Modal Header -->
        <div class="cart-modal-header">
            <h3 id="cart-modal-title" style="color: #000000;"><i class="fas fa-shopping-cart" aria-hidden="true"></i> Shopping Cart</h3>
            <button class="btn-close-modal" onclick="closeCartModal()" aria-label="Close cart modal">
                <i class="fas fa-times" aria-hidden="true"></i>
            </button>
        </div>
        
        <!-- Modal Body -->
        <div class="cart-modal-body">
            <div class="cart-items-container" id="cart-items-container" role="region" aria-label="Cart items">
                <!-- Cart items will be populated here -->
            </div>
            
            <!-- Empty Cart Message -->
            <div class="empty-cart-message" id="empty-cart-message" style="display: none;" role="status" aria-live="polite">
                <div class="empty-cart-icon">
                    <i class="fas fa-shopping-bag" aria-hidden="true"></i>
                </div>
                <h4>Your cart is empty</h4>
                <p>Add some products to get started!</p>
            </div>
        </div>
        
        <!-- Modal Footer -->
        <div class="cart-modal-footer">
            <div class="cart-summary">
                <div class="cart-summary-label">Total:</div>
                <div class="cart-summary-total" id="modal-cart-total" aria-label="Cart total amount">$0.00</div>
            </div>
            
            <div class="cart-actions">

                <button class="btn-clear-all" onclick="clearCart()" aria-label="Clear all items from cart">
                    <i class="fas fa-trash" aria-hidden="true"></i> Clear All
                </button>
                <button class="btn-factura" onclick="proceedToCheckout()" aria-label="Generate invoice">
                    <i class="fas fa-file-invoice" aria-hidden="true"></i> Factura
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Notification System -->
<div class="cart-notification" id="cart-notification" role="status" aria-live="polite" aria-hidden="true">
    <div class="notification-content">
        <i class="fas fa-check-circle" aria-hidden="true"></i>
        <span id="notification-message">Product added to cart!</span>
    </div>
    <button class="notification-close" onclick="closeNotification()" aria-label="Close notification">
        <i class="fas fa-times" aria-hidden="true"></i>
    </button>
</div>

<!-- JavaScript for Cart Functionality -->
<script>
// Cart functionality
let cart = [];

document.addEventListener('DOMContentLoaded', function() {
    try {
        // Load cart from localStorage
        loadCart();
        
        // Initialize search functionality
        initializeSearch();
        
        // Initialize product card interactions
        initializeProductCards();
        
        // Initialize accessibility features
        initializeAccessibility();
        
        // Initialize modal functionality
        initializeModal();
        
    } catch (error) {
        console.error('Error initializing store:', error);
    }
});

// Initialize search functionality
function initializeSearch() {
    try {
        const searchInput = document.querySelector('.search-input');
        if (searchInput) {
            let searchTimeout;
            
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    this.form.submit();
                }, 500);
            });
        }
    } catch (error) {
        console.error('Error initializing search:', error);
    }
}

// Initialize product card interactions
function initializeProductCards() {
    try {
        const productCards = document.querySelectorAll('.product-card');
        productCards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-8px)';
                this.style.boxShadow = '0 20px 40px rgba(0, 0, 0, 0.15)';
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.08)';
            });
        });
    } catch (error) {
        console.error('Error initializing product cards:', error);
    }
}

// Initialize accessibility features
function initializeAccessibility() {
    try {
        // Keyboard navigation for cart modal
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeCartModal();
            }
        });
        
        // Focus management
        const cartButton = document.querySelector('.cart-button');
        if (cartButton) {
            cartButton.addEventListener('focus', function() {
                this.setAttribute('aria-expanded', 'false');
            });
        }
    } catch (error) {
        console.error('Error initializing accessibility:', error);
    }
}

// Initialize modal functionality
function initializeModal() {
    try {
        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('cart-modal');
            const overlay = document.querySelector('.cart-modal-overlay');
            
            if (modal && overlay && event.target === overlay) {
                closeCartModal();
            }
        });
        
        // Prevent modal close when clicking inside modal content
        const modalContent = document.querySelector('.cart-modal-content');
        if (modalContent) {
            modalContent.addEventListener('click', function(event) {
                event.stopPropagation();
            });
        }
    } catch (error) {
        console.error('Error initializing modal:', error);
    }
}

// Modal functions
function openCartModal() {
    try {
        const modal = document.getElementById('cart-modal');
        if (modal) {
            modal.classList.add('active');
            modal.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
            
            // Update cart modal content
            updateCartModal();
            
            // Focus management
            const closeButton = modal.querySelector('.btn-close-modal');
            if (closeButton) {
                setTimeout(() => closeButton.focus(), 100);
            }
            
            // Update aria-expanded on cart button
            const cartButton = document.querySelector('.cart-button');
            if (cartButton) {
                cartButton.setAttribute('aria-expanded', 'true');
            }
        }
    } catch (error) {
        console.error('Error opening cart modal:', error);
    }
}

function closeCartModal() {
    try {
        const modal = document.getElementById('cart-modal');
        if (modal) {
            modal.classList.remove('active');
            modal.setAttribute('aria-hidden', 'true');
            document.body.style.overflow = 'auto';
            
            // Update aria-expanded on cart button
            const cartButton = document.querySelector('.cart-button');
            if (cartButton) {
                cartButton.setAttribute('aria-expanded', 'false');
                cartButton.focus();
            }
        }
    } catch (error) {
        console.error('Error closing cart modal:', error);
    }
}

// Add to cart function
function addToCart(productId, productName, productPrice) {
    try {
        console.log('addToCart called with:', { productId, productName, productPrice });
        console.log('Current cart before adding:', cart);
        
        const existingItem = cart.find(item => item.id === productId);
        
        if (existingItem) {
            existingItem.quantity += 1;
            console.log('Updated existing item quantity:', existingItem);
        } else {
            const newItem = {
                id: productId,
                name: productName,
                price: parseFloat(productPrice),
                quantity: 1
            };
            cart.push(newItem);
            console.log('Added new item to cart:', newItem);
        }
        
        console.log('Cart after adding item:', cart);
        
        updateCart();
        showNotification('Product added to cart!', 'success');
        
        // Update cart button aria-label
        const cartButton = document.querySelector('.cart-button');
        if (cartButton) {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartButton.setAttribute('aria-label', `Shopping cart with ${totalItems} items`);
        }
        
        console.log('addToCart completed successfully');
        
    } catch (error) {
        console.error('Error adding to cart:', error);
        showNotification('Error adding product to cart!', 'error');
    }
}

// Remove from cart function
function removeFromCart(productId) {
    try {
        cart = cart.filter(item => item.id !== productId);
        updateCart();
        updateCartModal();
        showNotification('Product removed from cart!', 'info');
        
        // Update cart button aria-label
        const cartButton = document.querySelector('.cart-button');
        if (cartButton) {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartButton.setAttribute('aria-label', `Shopping cart with ${totalItems} items`);
        }
        
    } catch (error) {
        console.error('Error removing from cart:', error);
        showNotification('Error removing product from cart!', 'error');
    }
}

// Update quantity function
function updateQuantity(productId, change) {
    try {
        const item = cart.find(item => item.id === productId);
        if (item) {
            item.quantity += change;
            if (item.quantity <= 0) {
                removeFromCart(productId);
            } else {
                updateCart();
                updateCartModal();
            }
        }
    } catch (error) {
        console.error('Error updating quantity:', error);
        showNotification('Error updating quantity!', 'error');
    }
}

// Update cart display
function updateCart() {
    try {
        console.log('updateCart called, current cart:', cart);
        
        const cartCount = document.getElementById('cart-count');
        const cartTotal = document.getElementById('cart-total');
        const modalCartTotal = document.getElementById('modal-cart-total');
        
        console.log('Cart elements found:', {
            cartCount: !!cartCount,
            cartTotal: !!cartTotal,
            modalCartTotal: !!modalCartTotal
        });
        
        // Calculate total
        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        
        console.log('Calculated totals:', { total, totalItems });
        
        // Update header cart
        if (cartCount) {
            cartCount.textContent = totalItems;
            console.log('Updated cart count:', totalItems);
        }
        if (cartTotal) {
            cartTotal.textContent = '$' + total.toFixed(2);
            console.log('Updated cart total:', '$' + total.toFixed(2));
        }
        
        // Update modal cart
        if (modalCartTotal) {
            modalCartTotal.textContent = '$' + total.toFixed(2);
            console.log('Updated modal cart total:', '$' + total.toFixed(2));
        }
        
        // Save cart to localStorage
        localStorage.setItem('storeCart', JSON.stringify(cart));
        console.log('Cart saved to localStorage');
        
        // Update cart button aria-label
        const cartButton = document.querySelector('.cart-button');
        if (cartButton) {
            cartButton.setAttribute('aria-label', `Shopping cart with ${totalItems} items`);
            console.log('Updated cart button aria-label');
        }
        
        console.log('updateCart completed successfully');
        
    } catch (error) {
        console.error('Error updating cart:', error);
    }
}

// Update cart modal content
function updateCartModal() {
    try {
        const container = document.getElementById('cart-items-container');
        const emptyMessage = document.getElementById('empty-cart-message');
        
        if (!container || !emptyMessage) return;
        
        if (cart.length === 0) {
            container.style.display = 'none';
            emptyMessage.style.display = 'block';
        } else {
            container.style.display = 'block';
            emptyMessage.style.display = 'none';
            
            container.innerHTML = '';
            cart.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'cart-item';
                itemElement.setAttribute('role', 'listitem');
                itemElement.setAttribute('aria-label', `${item.name}, quantity: ${item.quantity}, price: $${item.price.toFixed(2)}`);
                
                itemElement.innerHTML = `
                    <div class="cart-item-header">
                        <div class="cart-item-image">
                            <i class="fas fa-box" aria-hidden="true"></i>
                        </div>
                        <div class="cart-item-info">
                            <div class="cart-item-name">${item.name}</div>
                            <div class="cart-item-price">$${item.price.toFixed(2)}</div>
                        </div>
                    </div>
                    <div class="cart-item-controls">
                        <div class="quantity-controls">
                            <button class="btn-quantity" 
                                    onclick="updateQuantity('${item.id}', -1)" 
                                    aria-label="Decrease quantity of ${item.name}">-</button>
                            <span class="quantity-display" aria-label="Current quantity">${item.quantity}</span>
                            <button class="btn-quantity" 
                                    onclick="updateQuantity('${item.id}', 1)" 
                                    aria-label="Increase quantity of ${item.name}">+</button>
                        </div>
                        <button class="btn-remove-item" 
                                onclick="removeFromCart('${item.id}')" 
                                aria-label="Remove ${item.name} from cart">
                            <i class="fas fa-trash" aria-hidden="true"></i> Remove
                        </button>
                    </div>
                `;
                container.appendChild(itemElement);
            });
        }
    } catch (error) {
        console.error('Error updating cart modal:', error);
    }
}

// Load cart from localStorage
function loadCart() {
    try {
        const savedCart = localStorage.getItem('storeCart');
        if (savedCart) {
            cart = JSON.parse(savedCart);
            updateCart();
        }
    } catch (error) {
        console.error('Error loading cart:', error);
        cart = [];
    }
}

// Clear cart
function clearCart() {
    try {
        if (cart.length === 0) {
            showNotification('Cart is already empty!', 'info');
            return;
        }
        
        cart = [];
        updateCart();
        updateCartModal();
        showNotification('Cart cleared!', 'info');
        
        // Update cart button aria-label
        const cartButton = document.querySelector('.cart-button');
        if (cartButton) {
            cartButton.setAttribute('aria-label', 'Shopping cart with 0 items');
        }
        
    } catch (error) {
        console.error('Error clearing cart:', error);
        showNotification('Error clearing cart!', 'error');
    }
}

// Generate invoice
function proceedToCheckout() {
    try {
        if (cart.length === 0) {
            showNotification('Your cart is empty!', 'error');
            return;
        }
        
        // Save cart data to localStorage for the facture page
        localStorage.setItem('factureCart', JSON.stringify(cart));
        localStorage.setItem('factureDate', new Date().toISOString());
        
        // Show success message and redirect to facture page
        showNotification('Redirecting to facture page...', 'success');
        setTimeout(() => {
            closeCartModal();
            // Redirect to the facture page
            window.location.href = '{% url "facture" %}';
        }, 1000);
    } catch (error) {
        console.error('Error generating invoice:', error);
        showNotification('Error generating invoice!', 'error');
    }
}

// Show notification
function showNotification(message, type = 'success') {
    try {
        const notification = document.getElementById('cart-notification');
        const messageElement = document.getElementById('notification-message');
        
        if (!notification || !messageElement) return;
        
        messageElement.textContent = message;
        notification.className = `cart-notification notification-${type}`;
        notification.classList.add('show');
        notification.setAttribute('aria-hidden', 'false');
        
        // Auto-hide after 3 seconds
        setTimeout(() => {
            closeNotification();
        }, 3000);
        
    } catch (error) {
        console.error('Error showing notification:', error);
    }
}

// Close notification
function closeNotification() {
    try {
        const notification = document.getElementById('cart-notification');
        if (notification) {
            notification.classList.remove('show');
            notification.setAttribute('aria-hidden', 'true');
        }
    } catch (error) {
        console.error('Error closing notification:', error);
    }
}

// Debug function for testing cart functionality
function testCart() {
    console.log('=== CART TEST ===');
    console.log('Current cart:', cart);
    console.log('Cart length:', cart.length);
    
    // Test adding a product
    addToCart('test-1', 'Test Product', '19.99');
    console.log('After adding test product:', cart);
    
    // Test removing a product
    removeFromCart('test-1');
    console.log('After removing test product:', cart);
    
    console.log('=== END TEST ===');
}

// Log that test function is available
console.log('Cart test function available: testCart()');
</script>
{% endblock %}
