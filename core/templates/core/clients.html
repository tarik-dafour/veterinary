{% extends 'core/base.html' %}
{% load static %}

{% block title %}Client Management - Veterinary System{% endblock %}

{% block content %}
<!-- Client Management Styles -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link rel="stylesheet" href="{% static 'core/css/clients.css' %}">
<script src="{% static 'core/js/main.js' %}"></script>
<script src="{% static 'core/js/clients.js' %}"></script>

<!-- Page Header -->
<header class="page-header" role="banner" aria-label="Client management overview">
    <h1 class="page-title">
        <i class="fa-solid fa-user-plus" aria-hidden="true"></i>
        <span lang="en">Client Management</span>
    </h1>
    <p class="page-subtitle" lang="en">Manage your veterinary clinic clients and their information</p>
</header>

<!-- Edit Client Modal -->
{% if edit_client %}
<div id="editClientModal" class="modal" style="display: block !important; z-index: 9999;" role="dialog" aria-labelledby="edit-client-title" aria-modal="true">
    <div class="modal-content">
        <button class="close" onclick="closeEditClientModal()" aria-label="Close edit client modal">
            <i class="fa-solid fa-xmark" aria-hidden="true"></i>
        </button>
                    <h3 id="edit-client-title">
                <i class="fa-solid fa-edit" aria-hidden="true"></i> 
                <span lang="en">Edit Client</span>
            </h3>
        <form id="editClientForm" method="post" action="{% url 'clients' %}" aria-label="Edit client form">
            {% csrf_token %}
            <input type="hidden" name="edit_id" value="{{ edit_client.id }}">
            
            <div class="form-group">
                <label for="edit-prenom" class="form-label" lang="en">First Name</label>
                <input type="text" 
                       id="edit-prenom"
                       name="prenom" 
                       class="form-input" 
                       value="{{ edit_client.prenom }}" 
                       required
                       aria-describedby="edit-prenom-help">
                <div id="edit-prenom-help" class="help-text">Enter the client's first name</div>
            </div>
            
            <div class="form-group">
                <label for="edit-nom" class="form-label" lang="en">Last Name</label>
                <input type="text" 
                       id="edit-nom"
                       name="nom" 
                       class="form-input" 
                       value="{{ edit_client.nom }}" 
                       required
                       aria-describedby="edit-nom-help">
                <div id="edit-nom-help" class="help-text">Enter the client's last name</div>
            </div>
            
            <div class="form-group">
                <label for="edit-telephone" class="form-label" lang="en">Phone</label>
                <input type="tel" 
                       id="edit-telephone"
                       name="telephone" 
                       class="form-input" 
                       value="{{ edit_client.telephone }}" 
                       required
                       aria-describedby="edit-telephone-help">
                <div id="edit-telephone-help" class="help-text">Enter the client's phone number</div>
            </div>
            
            <div class="form-group">
                <label for="edit-email" class="form-label" lang="en">Email</label>
                <input type="email" 
                       id="edit-email"
                       name="email" 
                       class="form-input" 
                       value="{{ edit_client.email }}"
                       aria-describedby="edit-email-help">
                <div id="edit-email-help" class="help-text">Enter the client's email address (optional)</div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary" lang="fr">
                    <i class="fa-solid fa-save" aria-hidden="true"></i>
                    Update
                </button>
                <a href="{% url 'clients' %}{% if search_query %}?search={{ search_query }}{% endif %}" 
                   class="btn btn-secondary" 
                   lang="fr">
                    <i class="fa-solid fa-times" aria-hidden="true"></i>
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>
{% endif %}

<!-- Main Content -->
<main class="table-card" role="main" aria-label="Client management content">
    <div class="table-header">
        <h3 class="form-title">
            <i class="fa-solid fa-list-check" aria-hidden="true"></i> 
            <span lang="en">Client List</span>
        </h3>
        
        <!-- Search and Actions Form -->
        <form method="get" class="search-form" role="search" aria-label="Search clients">
            <div class="search-input-group">
                <input type="text" 
                       name="search" 
                       class="search-input" 
                       placeholder="Search for a client..." 
                       value="{{ search_query }}"
                       aria-label="Search clients"
                       lang="fr">
                <button class="btn btn-primary" type="submit" aria-label="Search">
                    <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
                </button>
            </div>
            
            <!-- Action Buttons -->
            <div class="action-buttons">
            {% if search_query %}
                <a class="btn btn-primary" href="{% url 'clients' %}" aria-label="Clear search">
                    <i class="fa-solid fa-xmark" aria-hidden="true"></i>
                </a>
            {% endif %}
                
                <a class="btn btn-primary" 
                   href="{% url 'export_clients_csv' %}?search={{ search_query }}"
                   aria-label="Export clients to CSV">
                    <i class="fa-solid fa-download" aria-hidden="true"></i>
                </a>
                <button type="button" class="btn btn-success" onclick="openClientModal()" aria-label="Add new client">
                    <i class="fa-solid fa-user-plus" aria-hidden="true"></i>
                </button>
            </div>
        </form>
    </div>

    <!-- Add Client Modal -->
    <div id="clientModal" class="modal" role="dialog" aria-labelledby="add-client-title" aria-modal="true">
        <div class="modal-content">
            <button class="close" onclick="closeClientModal()" aria-label="Close add client modal">
                <i class="fa-solid fa-xmark" aria-hidden="true"></i>
            </button>
            <h3 id="add-client-title">
                <i class="fa-solid fa-user-plus" aria-hidden="true"></i> 
                <span lang="en">Add a Client</span>
            </h3>
            <form id="addClientForm" method="post" action="{% url 'clients' %}" aria-label="Add client form">
                {% csrf_token %}
                
                <div class="form-group">
                    <label for="add-prenom" class="form-label" lang="en">First Name</label>
                    <input type="text" id="add-prenom" name="prenom" class="form-input" required aria-describedby="add-prenom-help">
                    <div id="add-prenom-help" class="help-text">Enter the client's first name</div>
                </div>
                
                <div class="form-group">
                    <label for="add-nom" class="form-label" lang="en">Last Name</label>
                    <input type="text" id="add-nom" name="nom" class="form-input" required aria-describedby="add-nom-help">
                    <div id="add-nom-help" class="help-text">Enter the client's last name</div>
                </div>
                
                <div class="form-group">
                    <label for="add-telephone" class="form-label" lang="en">Phone</label>
                    <input type="tel" id="add-telephone" name="telephone" class="form-input" required aria-describedby="add-telephone-help">
                    <div id="add-telephone-help" class="help-text">Enter the client's phone number</div>
                </div>
                
                <div class="form-group">
                    <label for="add-email" class="form-label" lang="en">Email</label>
                    <input type="email" id="add-email" name="email" class="form-input" aria-describedby="add-email-help">
                    <div id="add-email-help" class="help-text">Enter the client's email address (optional)</div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" lang="fr">
                        <i class="fa-solid fa-plus" aria-hidden="true"></i>
                        Add
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Clients Table -->
    <div class="table-container">
        <!-- Bulk Actions Bar -->
        <div class="bulk-actions-bar" id="bulkActionsBar" style="display: none;">
            <div class="bulk-actions-info">
                <span id="selectedCount">0</span> client(s) selected
            </div>
            <div class="bulk-actions-buttons">
                <button type="button" class="btn btn-danger" onclick="bulkDeleteClients()" aria-label="Delete selected clients">
                    <i class="fa-solid fa-trash" aria-hidden="true"></i>
                    <span lang="en">Delete Selection</span>
                </button>
                <button type="button" class="btn btn-secondary" onclick="clearSelection()" aria-label="Clear selection">
                    <i class="fa-solid fa-times" aria-hidden="true"></i>
                    <span lang="en">Cancel</span>
                </button>
            </div>
        </div>

        <table class="table" role="table" aria-label="Clients list">
            <thead>
                <tr>
                    <th scope="col" class="th-checkbox">
                        <input type="checkbox" id="selectAll" class="select-all-checkbox" onchange="toggleSelectAll()" aria-label="Select all clients">
                    </th>
                    <th scope="col" class="th-name" lang="en">Name</th>
                    <th scope="col" class="th-phone" lang="en"><i class="fa-solid fa-phone" aria-hidden="true"></i> Phone</th>
                    <th scope="col" class="th-email" lang="fr"><i class="fa-solid fa-envelope" aria-hidden="true"></i> Email</th>
                    <th scope="col" class="th-actions" lang="en">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for client in clients %}
                <tr class="table-row" data-client-id="{{ client.id }}">
                    <td class="td-checkbox">
                        <input type="checkbox" class="client-checkbox" value="{{ client.id }}" aria-label="Select client {{ client.prenom }} {{ client.nom }}">
                    </td>
                    <td class="td-name">
                        <div class="client-info">
                            <div class="client-name">{{ client.prenom }} {{ client.nom }}</div>
                            <div class="client-id">ID: {{ client.id }}</div>
                        </div>
                    </td>
                    <td class="td-phone">
                        <a href="tel:{{ client.telephone }}" aria-label="Call {{ client.telephone }}">
                            {{ client.telephone }}
                        </a>
                    </td>
                    <td class="td-email">
                        {% if client.email %}
                        <a href="mailto:{{ client.email }}" aria-label="Email {{ client.email }}">
                            {{ client.email }}
                        </a>
                        {% else %}
                        <span class="no-email" aria-label="No email provided">-</span>
                        {% endif %}
                    </td>
                    <td class="td-actions">
                        <div class="action-buttons">
                            <button class="btn btn-edit" onclick="editClient({{ client.id }})" aria-label="Edit client {{ client.prenom }} {{ client.nom }}">
                                <i class="fa-solid fa-edit" aria-hidden="true"></i>
                            </button>
                            <button class="btn btn-delete" onclick="deleteClient({{ client.id }})" aria-label="Delete client {{ client.prenom }} {{ client.nom }}" style="background: linear-gradient(135deg, #dc3545, #ff6b6b);color: white;">
                                <i class="fa-solid fa-trash" aria-hidden="true"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr class="empty-row">
                    <td colspan="5" class="empty-message">
                        <div class="empty-state">
                            <i class="fa-solid fa-users empty-icon" aria-hidden="true"></i>
                            <h3 lang="en">No clients found</h3>
                            <p lang="en">Start by adding your first client</p>
                            <button class="btn btn-primary" onclick="openClientModal()">
                                <i class="fa-solid fa-user-plus" aria-hidden="true"></i>
                                <span lang="en">Add a Client</span>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if clients.has_other_pages %}
    <nav class="pagination" role="navigation" aria-label="Client list pagination">
        <ul class="pagination-list">
            {% if clients.has_previous %}
            <li>
                <a href="?page={{ clients.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}" class="pagination-link" aria-label="Go to previous page">
                    <i class="fa-solid fa-chevron-left" aria-hidden="true"></i>
                </a>
            </li>
            {% endif %}
            
            {% for num in clients.paginator.page_range %}
                {% if clients.number == num %}
                <li>
                    <span>{{ num }}</span>
                </li>
                {% elif num > clients.number|add:'-3' and num < clients.number|add:'3' %}
                <li>
                    <a href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}" 
                       class="pagination-link">{{ num }}</a>
                </li>
                {% endif %}
            {% endfor %}
            
            {% if clients.has_next %}
            <li>
                <a href="?page={{ clients.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}" class="pagination-link" aria-label="Go to next page">
                    <i class="fa-solid fa-chevron-right" aria-hidden="true"></i>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</main>

<!-- Initialize bulk selection when page loads -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // The bulk selection functionality is already implemented in clients.js
        // This script ensures proper initialization
        if (typeof initializeBulkSelection === 'function') {
            initializeBulkSelection();
        }
    });
</script>

{% endblock %}