{% extends 'core/base.html' %}
{% load static %}

{% block title %}Dashboard - Veterinary Management{% endblock %}

{% block content %}
<!-- Dashboard Styles -->
<link rel="stylesheet" href="{% static 'core/css/dash.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Kumbh+Sans:wght@100..900&display=swap" rel="stylesheet">

<!-- FullCalendar -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.8/index.global.min.js"></script>

<!-- Dashboard Main Content -->
<main class="dashboard" role="main" aria-label="Dashboard Overview">
    <!-- Row 1: KPI Cards Section -->
    <section class="dashboard-row kpi-row" aria-label="Key Performance Indicators">
        <article class="kpi-card new-clients" role="article" aria-labelledby="new-clients-title">
            <div class="kpi-header">
                <div class="kpi-content">
                    <h3 id="new-clients-title" class="kpi-title">New Clients</h3>
                    <div class="kpi-value" aria-label="New clients this month">{{ new_clients_this_month|default:"0" }}</div>
                    <div class="kpi-trend trend-up">
                        <span class="trend-label">This month</span>
                    </div>
                </div>
                <div class="kpi-icon" aria-hidden="true">
                    <i class="fa-solid fa-user-plus"></i>
                </div>
            </div>
        </article>

        <article class="kpi-card total-clients" role="article" aria-labelledby="total-clients-title">
            <div class="kpi-header">
                <div class="kpi-content">
                    <h3 id="total-clients-title" class="kpi-title">Total Clients</h3>
                    <div class="kpi-value" aria-label="Total registered clients">{{ total_clients|default:"0" }}</div>
                    <div class="kpi-trend trend-up">
                        <span class="trend-label">Registered clients</span>
                    </div>
                </div>
                <div class="kpi-icon" aria-hidden="true">
                    <i class="fa-solid fa-user"></i>
                </div>
            </div>
        </article>

        <article class="kpi-card total-animals" role="article" aria-labelledby="total-animals-title">
            <div class="kpi-header">
                <div class="kpi-content">
                    <h3 id="total-animals-title" class="kpi-title">Total Animals</h3>
                    <div class="kpi-value" aria-label="Total registered animals">{{ total_animals|default:"0" }}</div>
                    <div class="kpi-trend trend-up">
                        <span class="trend-label">Registered animals</span>
                    </div>
                </div>
                <div class="kpi-icon" aria-hidden="true">
                    <i class="fa-solid fa-paw"></i>
                </div>
            </div>
        </article>

        <article class="kpi-card total-reservations" role="article" aria-labelledby="total-reservations-title">
            <div class="kpi-header">
                <div class="kpi-content">
                    <h3 id="total-reservations-title" class="kpi-title">Total Reservations</h3>
                    <div class="kpi-value" aria-label="Total appointments">{{ total_reservations|default:"0" }}</div>
                    <div class="kpi-trend trend-up">
                        <span class="trend-label">All appointments</span>
                    </div>
                </div>
                <div class="kpi-icon" aria-hidden="true">
                    <i class="fa-solid fa-clipboard-list"></i>
                </div>
            </div>
        </article>
    </section>

    <!-- Row 2: Appointments | Calendar -->
    <section class="dashboard-row appointments-calendar-row" aria-label="Appointments and Calendar">
        <article class="appointments-panel" role="article" aria-labelledby="appointments-header">
            <header class="panel-header">
                <h3 id="appointments-header">
                    <i class="fa-solid fa-calendar-check" aria-hidden="true"></i> 
                    Appointments
                </h3>
            </header>
            <div class="appointments-list" role="list" aria-label="Upcoming appointments">
                {% for appointment in upcoming_appointments %}
                <div class="appointment-item" role="listitem">
                    <div class="appointment-icon" aria-hidden="true">
                        <i class="fa-solid fa-paw"></i>
                    </div>
                    <div class="appointment-info">
                        <div class="appointment-service">{{ appointment.service }}</div>
                        <div class="appointment-client">
                            {{ appointment.client.nom }} {{ appointment.client.prenom }} - {{ appointment.animal.nom }}
                        </div>
                    </div>
                    <div class="appointment-time" aria-label="Appointment time">
                        {{ appointment.date_reservation|time:"g:i A" }}
                    </div>
                </div>
                {% empty %}
                <div class="appointment-item empty" role="listitem">
                    <div class="appointment-icon" aria-hidden="true">
                        <i class="fa-solid fa-calendar"></i>
                    </div>
                    <div class="appointment-info">
                        <div class="appointment-service">No upcoming appointments</div>
                        <div class="appointment-client">No appointments scheduled for today</div>
                    </div>
                </div>
                {% endfor %}
                <div class="appointments-summary" aria-label="Appointments summary">
                    <i class="fa-solid fa-calendar-days" aria-hidden="true"></i>
                    <span>Appointments Today: {{ upcoming_appointments|length }}</span>
                </div>
            </div>
        </article>
        
        <article class="calendar-panel" role="article" aria-labelledby="calendar-header">
            <header class="panel-header">
                <h3 id="calendar-header">
                    <i class="fa-solid fa-calendar-alt" aria-hidden="true"></i> 
                    Calendar
                </h3>
            </header>
            <div id="calendar" aria-label="Appointments calendar"></div>
        </article>
    </section>

    <!-- Row 3: Low Stock Alerts | Quick Actions -->
    <section class="dashboard-row stock-actions-row" aria-label="Stock alerts and quick actions">
        <article class="low-stock-panel" role="article" aria-labelledby="stock-header">
            <header class="panel-header">
                <h3 id="stock-header">
                    <i class="fa-solid fa-exclamation-triangle" aria-hidden="true"></i> 
                    Low Stock Alerts
                </h3>
            </header>
            <div class="stock-alerts-list" role="list" aria-label="Low stock items">
                {% for product in stock_alerts %}
                <div class="stock-alert-item" role="listitem">
                    <div class="stock-icon" aria-hidden="true">
                        <i class="fa-solid fa-box"></i>
                    </div>
                    <div class="stock-info">
                        <div class="stock-name">{{ product.nom }}</div>
                        <div class="stock-details">
                            {{ product.categorie.nom }} - {{ product.fournisseur.nom }}
                        </div>
                    </div>
                    <div class="stock-quantity">
                        <span class="quantity-badge" aria-label="Remaining quantity">
                            {{ product.quantite }} left
                        </span>
                    </div>
                </div>
                {% empty %}
                <div class="stock-alert-item empty" role="listitem">
                    <div class="stock-icon" aria-hidden="true">
                        <i class="fa-solid fa-check-circle"></i>
                    </div>
                    <div class="stock-info">
                        <div class="stock-name">All stock levels are good</div>
                        <div class="stock-details">No low stock alerts</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </article>
        
        <article class="quick-actions-panel" role="article" aria-labelledby="actions-header">
            <header class="panel-header">
                <h3 id="actions-header">
                    <i class="fa-solid fa-plus" aria-hidden="true"></i> 
                    Quick Actions
                </h3>
            </header>
            <div class="quick-actions-content">
                <nav class="quick-actions" role="navigation" aria-label="Quick actions menu">
                    <a href="{% url 'clients' %}" class="action-item" aria-label="Add new client">
                        <i class="fa-solid fa-plus-circle" aria-hidden="true"></i>
                        <span>Add New Client</span>
                    </a>
                    <a href="{% url 'reservation' %}" class="action-item" aria-label="Schedule appointment">
                        <i class="fa-solid fa-calendar-plus" aria-hidden="true"></i>
                        <span>Schedule Appointment</span>
                    </a>
                    <a href="{% url 'stock' %}" class="action-item" aria-label="Add product to stock">
                        <i class="fa-solid fa-box-open" aria-hidden="true"></i>
                        <span>Add Product</span>
                    </a>
                    <a href="{% url 'users' %}" class="action-item" aria-label="Add team member">
                        <i class="fa-solid fa-user-plus" aria-hidden="true"></i>
                        <span>Add Team Member</span>
                    </a>
                </nav>
            </div>
        </article>
    </section>

    <!-- Row 4: Team Members -->
    <section class="dashboard-row team-row" aria-label="Team members">
        <article class="team-panel" role="article" aria-labelledby="team-header">
            <header class="panel-header">
                <h3 id="team-header">
                    <i class="fa-solid fa-users" aria-hidden="true"></i> 
                    Team Members
                </h3>
            </header>
            <div class="team-members-grid" role="list" aria-label="Team members list">
                {% for member in team_members %}
                <div class="team-member" role="listitem">
                    <div class="member-avatar" aria-label="Member avatar">
                        {{ member.user.get_full_name|default:member.user.username|first|upper }}
                        <div class="status-dot status-online" aria-label="Online status"></div>
                    </div>
                    <div class="member-info">
                        <div class="member-name">{{ member.user.get_full_name|default:member.user.username }}</div>
                        <div class="member-role">{{ member.get_role_display }}</div>
                    </div>
                </div>
                {% empty %}
                <div class="team-member empty" role="listitem">
                    <div class="member-avatar" aria-hidden="true">
                        <i class="fa-solid fa-users"></i>
                    </div>
                    <div class="member-info">
                        <div class="member-name">No team members</div>
                        <div class="member-role">Add team members to get started</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </article>
    </section>
</main>

<!-- Calendar Initialization Script -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        try {
            // Initialize FullCalendar
            var calendarEl = document.getElementById('calendar');
            if (calendarEl) {
                var calendar = new FullCalendar.Calendar(calendarEl, {
                    // Basic Settings
                    initialView: 'dayGridMonth',
                    height: 'auto',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth'
                    },
                    events: "{% url 'all_appointments' %}",
                    editable: true,
                    selectable: true,
                    selectMirror: true,
                    dayMaxEvents: true,
                    
                    // Event handling
                    eventClick: function(info) {
                        try {
                            // Show appointment details
                            const eventTitle = info.event.title || 'Appointment';
                            const eventDate = info.event.start ? 
                                new Date(info.event.start).toLocaleDateString() : 'Unknown date';
                            
                            // Create a more accessible alert
                            const message = `Appointment: ${eventTitle}\nDate: ${eventDate}`;
                            
                            // Use a custom notification instead of alert for better UX
                            showNotification(message, 'info');
                        } catch (error) {
                            console.error('Error handling event click:', error);
                            showNotification('Error loading appointment details', 'error');
                        }
                    },
                    
                    // Selection handling
                    select: function(info) {
                        try {
                            const selectedDate = info.startStr;
                            // Redirect to reservation page with selected date
                            window.location.href = `{% url 'reservation' %}?date=${selectedDate}`;
                        } catch (error) {
                            console.error('Error handling date selection:', error);
                            showNotification('Error selecting date', 'error');
                        }
                    },
                    
                    // Event rendering
                    eventDidMount: function(info) {
                        try {
                            // Add custom styling to events
                            info.el.style.cursor = 'pointer';
                            info.el.setAttribute('role', 'button');
                            info.el.setAttribute('tabindex', '0');
                            info.el.setAttribute('aria-label', `Appointment: ${info.event.title}`);
                            
                            // Add keyboard support
                            info.el.addEventListener('keydown', function(e) {
                                if (e.key === 'Enter' || e.key === ' ') {
                                    e.preventDefault();
                                    info.event.setProp('display', 'background');
                                }
                            });
                        } catch (error) {
                            console.error('Error mounting event:', error);
                        }
                    }
                });
                
                calendar.render();
                console.log('Calendar initialized successfully');
            } else {
                console.error('Calendar element not found');
            }
        } catch (error) {
            console.error('Error initializing calendar:', error);
            showNotification('Error loading calendar', 'error');
        }
    });
    
    // Notification system for better UX
    function showNotification(message, type = 'info') {
        try {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `dashboard-notification notification-${type}`;
            notification.setAttribute('role', 'alert');
            notification.setAttribute('aria-live', 'polite');
            
            // Set content
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fa-solid fa-${type === 'error' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle'}" aria-hidden="true"></i>
                    <span>${message}</span>
                    <button class="notification-close" aria-label="Close notification" onclick="this.parentElement.parentElement.remove()">
                        <i class="fa-solid fa-times" aria-hidden="true"></i>
                    </button>
                </div>
            `;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
            
        } catch (error) {
            console.error('Error showing notification:', error);
            // Fallback to alert
            alert(message);
        }
    }
    
    // Add keyboard navigation for dashboard
    document.addEventListener('keydown', function(e) {
        try {
            // Escape key to close any open modals or panels
            if (e.key === 'Escape') {
                // Close any open dropdowns or modals
                const openElements = document.querySelectorAll('.open, .active');
                openElements.forEach(el => el.classList.remove('open', 'active'));
            }
            
            // Tab navigation enhancement
            if (e.key === 'Tab') {
                const focusableElements = document.querySelectorAll(
                    'a[href], button, input, textarea, select, [tabindex]:not([tabindex="-1"])'
                );
                
                // Add visual focus indicator
                focusableElements.forEach(el => {
                    el.addEventListener('focus', function() {
                        this.style.outline = '2px solid var(--primary-blue)';
                        this.style.outlineOffset = '2px';
                    });
                    
                    el.addEventListener('blur', function() {
                        this.style.outline = '';
                        this.style.outlineOffset = '';
                    });
                });
            }
        } catch (error) {
            console.error('Error handling keyboard navigation:', error);
        }
    });
</script>

<!-- Dashboard Notification Styles -->
<style>
    .dashboard-notification {
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        border: 1px solid #e2e8f0;
        padding: 1rem 1.5rem;
        z-index: 2000;
        max-width: 400px;
        animation: slideInRight 0.3s ease-out;
    }
    
    .notification-content {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .notification-content i {
        font-size: 1.25rem;
    }
    
    .notification-info i {
        color: #4299e1;
    }
    
    .notification-success i {
        color: #48bb78;
    }
    
    .notification-error i {
        color: #f56565;
    }
    
    .notification-close {
        background: none;
        border: none;
        color: #718096;
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 0.25rem;
        margin-left: auto;
        transition: all 0.2s ease;
    }
    
    .notification-close:hover {
        background: #f7fafc;
        color: #4a5568;
    }
    
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @media (max-width: 768px) {
        .dashboard-notification {
            top: 1rem;
            right: 1rem;
            left: 1rem;
            max-width: none;
        }
    }
</style>
{% endblock %}

